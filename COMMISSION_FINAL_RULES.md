# 手续费扣除规则 - 最终版

## 核心原则

**只有在当前交易被完全平仓时才计算手续费+税费，其他情况都不计算。任何时候都不要按比例计算。**

---

## 详细规则

**手续费和税费的计算逻辑完全一致，遵循相同的扣除规则。**

### 1. 开仓记录的手续费和税费扣除

**统一规则**：
- **开仓时**：记录手续费和税费，但不扣除（不计算到盈亏中）
- **完全平仓时**：扣除开仓记录的全部手续费和税费（不是按比例）
- **部分平仓时**：不扣除开仓记录的手续费和税费

**具体场景**：
- **买入开多仓**：记录手续费和税费（如有），完全平仓时扣除全部手续费和税费
- **卖出开空仓**：记录手续费和税费，完全平仓时扣除全部手续费和税费

---

### 2. 平仓交易的手续费和税费计算

**统一规则**：
- **平仓交易全部用于平仓（没有开新仓）**：在最后一次平仓时，计算整笔平仓交易的手续费和税费
- **平仓交易部分用于平仓、部分开新仓**：不计算平仓交易的手续费和税费（开新仓的部分会在将来平仓时计算）

**具体场景**：

#### 2.1 卖出平多仓（SELL）

**情况A：卖出交易全部用于平仓（没有开新空仓）**
- 在**最后一次平仓时**，计算整笔卖出交易的手续费和税费
- 之前的平仓不计算卖出交易的手续费和税费

**情况B：卖出交易部分用于平仓、部分开新空仓**
- 不计算卖出交易的手续费和税费（开新空仓的部分会在将来平仓时计算）

#### 2.2 买入平空仓（BUY）

**情况A：买入交易全部用于平空仓（没有开新多仓）**
- 在**最后一次平空仓时**，计算整笔买入交易的手续费和税费
- 之前的平空仓不计算买入交易的手续费和税费

**情况B：买入交易部分用于平空仓、部分开新多仓**
- 不计算买入交易的手续费和税费（开新多仓的部分会在将来平仓时计算）

---

## 判断条件

### 判断开仓记录是否完全平仓
```javascript
if (usedQty === longPos.quantity) {
  // 完全平仓，扣除开仓记录的全部手续费和税费
  buyCommission = longPos.commission || 0;
} else {
  // 部分平仓，不扣除开仓记录的手续费和税费
  buyCommission = 0;
}
```

### 判断平仓交易是否全部用于平仓（没有开新仓）
```javascript
// 先模拟计算 remainingQty 最终是否为0
let tempRemainingQty = transaction.quantity;
for (const pos of oppositePositions) {
  if (tempRemainingQty <= 0) break;
  tempRemainingQty -= Math.min(tempRemainingQty, pos.quantity);
}
const isFullyClosing = (tempRemainingQty === 0);

// 在循环中判断是否是最后一次平仓
const isLastClosing = (remainingQty - usedQty === 0);

// 只有在最后一次平仓时才计算整笔交易的手续费和税费
if (isFullyClosing && isLastClosing) {
  // 计算整笔交易的手续费和税费
} else {
  // 不计算
}
```

---

## 计算公式

**手续费和税费统一处理，遵循相同的扣除规则。**

### 平多仓盈亏
```
盈亏 = 卖出金额 
     - 买入成本 
     - 买入手续费（完全平仓时扣除） 
     - 买入税费（完全平仓时扣除） 
     - 卖出手续费（最后一次平仓时计算整笔，如果全部用于平仓） 
     - 卖出税费（最后一次平仓时计算整笔，如果全部用于平仓）
```

### 平空仓盈亏
```
盈亏 = 开空仓收入 
     - 平空仓成本 
     - 开空仓手续费（完全平仓时扣除） 
     - 开空仓税费（完全平仓时扣除） 
     - 买入手续费（最后一次平仓时计算整笔，如果全部用于平空仓）
     - 买入税费（如果有，最后一次平仓时计算整笔，如果全部用于平空仓）
```

**说明**：手续费和税费的计算和扣除规则完全相同，都遵循"完全平仓才扣除"和"全部用于平仓才计算"的原则。

---

## 扣除时机总结表

**手续费和税费遵循相同的扣除规则，统一处理。**

| 交易类型 | 开仓时 | 部分平仓时 | 完全平仓时 | 平仓交易全部用于平仓 | 平仓交易部分开新仓 |
|---------|--------|-----------|-----------|-------------------|------------------|
| **买入开多仓** | 记录手续费，不扣除 | 不扣除手续费和税费 | 扣除手续费和税费的全部 | - | - |
| **卖出平多仓** | - | 不计算卖出交易手续费和税费（如果不是最后一次平仓） | 计算整笔卖出交易手续费和税费（如果是最后一次平仓） | 最后一次平仓时计算整笔交易费用 | 不计算卖出交易费用 |
| **卖出开空仓** | 记录手续费和税费，不扣除 | 不扣除手续费和税费 | 扣除手续费和税费的全部 | - | - |
| **买入平空仓** | - | 不计算买入交易手续费和税费（如果不是最后一次平仓） | 计算整笔买入交易手续费和税费（如果是最后一次平仓） | 最后一次平仓时计算整笔交易费用 | 不计算买入交易费用 |

**说明**：表格中的"手续费和税费"包含所有相关费用，它们遵循相同的扣除规则。

---

## 重要原则

**手续费和税费的计算逻辑完全一致，遵循相同的原则。**

1. ✅ **开仓记录的手续费和税费**：只有在开仓记录被完全平仓时才扣除，不是按比例
2. ✅ **平仓交易的手续费和税费**：只有在平仓交易全部用于平仓时，在最后一次平仓时计算整笔交易费用
3. ✅ **任何时候都不要按比例计算**手续费和税费
4. ✅ **部分平仓不扣除**开仓记录的手续费和税费
5. ✅ **部分开新仓不计算**平仓交易的手续费和税费
6. ✅ **手续费和税费统一处理**：无论是手续费还是税费，都遵循相同的扣除规则

---

## 示例场景

### 示例1：买入200股 → 卖出100股 → 卖出100股

- 买入200股：记录手续费和税费，不扣除
- 卖出100股（第一笔卖出交易，全部用于平仓）：
  - 不扣除买入手续费和税费（买入200股还没完全平仓）
  - **计算卖出100股的手续费和税费**（因为这笔卖出100股全部用于平仓，是这笔交易的最后一次平仓）
- 卖出100股（第二笔卖出交易，全部用于平仓）：
  - 扣除买入200股的全部手续费和税费（买入200股现在完全平仓了）
  - **计算卖出100股的手续费和税费**（因为这笔卖出100股全部用于平仓，是这笔交易的最后一次平仓）

**说明**：每笔卖出交易都是独立的，如果一笔卖出交易全部用于平仓，则在该笔交易的最后一次平仓时计算该笔交易的完整手续费和税费。

### 示例2：买入100股@10元 → 买入100股@9元 → 卖出150股 → 卖出50股

- 买入100股@10元：记录手续费和税费，不扣除
- 买入100股@9元：记录手续费和税费，不扣除
- 卖出150股（全部用于平仓）：
  - 第一次平100股@9元：扣除买入100股@9元的全部手续费和税费，不计算卖出150股的手续费和税费
  - 第二次平50股@10元：不扣除买入100股@10元的手续费和税费，计算卖出150股的完整手续费和税费
- 卖出50股：扣除买入100股@10元的全部手续费和税费，计算卖出50股的手续费和税费

### 示例3：买入100股 → 卖出150股（平100股 + 开空仓50股）

- 买入100股：记录手续费和税费，不扣除
- 卖出150股（部分用于平仓、部分开新空仓）：
  - 平100股：扣除买入100股的全部手续费和税费，**不计算**卖出150股的手续费和税费（因为部分开新空仓）
  - 开空仓50股：记录手续费和税费，不扣除

---

## 代码实现位置

### 主要实现（已更新）

- **stockService.js**: 
  - `calculateClosedProfitLossAndDetails()` - 计算所有已平仓的盈亏明细
  - ✅ 已实现完整的"全部用于平仓"逻辑
  - ✅ 已实现"不按比例计算"逻辑
  - ✅ 买入开多仓：只在完全平仓时扣除买入手续费
  - ✅ 卖出平多仓：只在全部用于平仓时，在最后一次平仓时计算整笔卖出交易的手续费和税费
  - ✅ 卖出开空仓：只在完全平仓时扣除开空仓手续费和税费
  - ✅ 买入平空仓：只在全部用于平空仓时，在最后一次平空仓时计算整笔买入交易的手续费

### 辅助方法（用于单笔交易创建/更新时）

- **transactionService.js**: 
  - `calculateProfitLossForCloseLong()` - 计算单笔卖出交易的盈亏（用于创建/更新交易时）
  - `calculateProfitLossForCloseShort()` - 计算单笔买入平空仓交易的盈亏（用于创建/更新交易时）
  - ⚠️ 注意：这些方法传入的是实际平仓的数量，不涉及整笔交易是否全部用于平仓的判断
  - ⚠️ 这些方法目前直接计算卖出手续费和买入手续费，但实际使用时只用于计算当前交易的盈亏，不影响整体逻辑

## 代码逻辑检查结果

### ✅ stockService.js - calculateClosedProfitLossAndDetails()

**平多仓逻辑（SELL）：**
1. ✅ 判断卖出交易是否全部用于平仓（通过模拟计算 `tempRemainingSellQty` 是否为0）
2. ✅ 如果全部用于平仓，计算整笔卖出交易的手续费和税费
3. ✅ 在最后一次平仓时，才扣除整笔卖出交易的手续费和税费
4. ✅ 如果不是最后一次平仓，不扣除卖出交易的手续费和税费
5. ✅ 如果部分开新空仓，完全不计算卖出交易的手续费和税费
6. ✅ 买入手续费只在买入记录完全平仓时扣除

**平空仓逻辑（BUY）：**
1. ✅ 判断买入交易是否全部用于平空仓（通过模拟计算 `tempRemainingBuyQty` 是否为0）
2. ✅ 如果全部用于平空仓，计算整笔买入交易的手续费
3. ✅ 在最后一次平空仓时，才扣除整笔买入交易的手续费
4. ✅ 如果不是最后一次平空仓，不扣除买入交易的手续费
5. ✅ 如果部分开新多仓，完全不计算买入交易的手续费
6. ✅ 开空仓手续费和税费只在空仓完全平仓时扣除

### ⚠️ transactionService.js - 辅助方法

**说明：**
- `calculateProfitLossForCloseLong()` 和 `calculateProfitLossForCloseShort()` 用于在创建/更新单笔交易时计算盈亏
- 这些方法传入的是实际平仓的数量（`closeQuantity`），不是整笔交易的数量
- 它们只计算当前这笔平仓操作的盈亏，不涉及"整笔交易是否全部用于平仓"的判断
- 这些方法目前直接计算手续费，但在实际业务中，最终的盈亏明细是通过 `stockService.js` 中的方法计算的
- 如果需要，这些方法也可以更新，但影响较小

### 总结

- ✅ **主要逻辑已正确实现**：`stockService.js` 中的 `calculateClosedProfitLossAndDetails()` 方法已完全符合新规则
- ✅ **核心原则已遵循**：不按比例计算，只在完全平仓时扣除，只在全部用于平仓时计算整笔交易费用
- ⚠️ **辅助方法**：`transactionService.js` 中的方法可能需要后续优化，但不影响主要功能

