# 股票交易记录系统 - 功能文档

## 目录
1. [系统概述](#系统概述)
2. [核心功能](#核心功能)
3. [数据库设计](#数据库设计)
4. [API接口](#api接口)
5. [前端页面](#前端页面)
6. [业务逻辑](#业务逻辑)
7. [技术实现](#技术实现)

---

## 系统概述

股票交易记录系统是一个用于记录和管理股票交易记录、自动计算盈亏的Web应用程序。系统支持A股、港股、美股三种股票类型，能够自动处理多仓和空仓的平仓逻辑，并根据股票类型自动计算手续费和税费。

### 主要特性
- ✅ 股票管理（添加、编辑、删除股票）
- ✅ 交易记录管理（买入/卖出记录）
- ✅ 自动持仓计算（支持多仓和空仓）
- ✅ 自动盈亏计算（最大化收益算法）
- ✅ 手续费和税费自动计算
- ✅ 股票详情页（持仓、盈亏、开平仓明细）
- ✅ 多货币单位支持（人民币、港元、美元）

---

## 核心功能

### 1. 股票管理

#### 1.1 功能描述
管理股票基本信息，包括股票名称和股票类型。

#### 1.2 功能点
- **添加股票**
  - 股票名称：必填，最大长度100字符，唯一
  - 股票类型：必填，下拉选择（A股、港股、美股）
  - 验证：股票名称不能为空，不能重复

- **编辑股票**
  - 可修改股票名称和股票类型
  - 保留原有ID和创建时间

- **删除股票**
  - 删除前需要确认
  - 如果存在关联的交易记录，删除会失败（外键约束）

- **股票列表**
  - 显示所有股票
  - 显示ID、名称、类型、创建时间
  - 提供编辑和删除操作

#### 1.3 股票类型说明
- **A股**：使用人民币（¥），手续费万1.2，税费仅卖出时收取万分之5
- **港股**：使用港元（HK$），手续费万2，税费买入卖出都收取千分之1
- **美股**：使用美元（$），手续费手动输入，无税费

#### 1.4 数据存储
- 数据库中使用数字存储：1=A股，2=港股，3=美股
- 前端显示时转换为中文文本

---

### 2. 交易记录管理

#### 2.1 功能描述
记录股票的买入和卖出交易，系统会自动判断是开仓还是平仓。

#### 2.2 添加交易记录

**必填字段：**
- **股票名称**：下拉选择，只能选择已添加的股票
- **交易类型**：单选按钮（买入/卖出）
- **数量（股）**：正整数，必填
- **价格（元）**：正数，支持小数，必填
- **交易日期**：日期选择器，必填

**可选字段：**
- **备注**：文本输入，可选

**自动计算字段：**
- **总金额**：数量 × 价格，自动计算
- **手续费**：根据股票类型和交易类型自动计算
  - A股：买入/卖出 = 总金额 × 0.00012（万1.2）
  - 港股：买入/卖出 = 总金额 × 0.0002
  - 美股：手动输入
- **税费**：根据股票类型和交易类型自动计算
  - A股：仅卖出 = 总金额 × 0.0005（万分之5）
  - 港股：买入/卖出 = 总金额 × 0.001
  - 美股：0

**表单验证：**
- 股票名称必选
- 数量必须大于0的整数
- 价格必须大于0
- 交易日期必填
- 美股必须输入手续费

#### 2.3 编辑交易记录
- 可修改所有字段
- 修改后重新计算盈亏
- 保留原始创建时间

#### 2.4 删除交易记录
- 仅在股票详情页的"成交记录明细"中可删除
- 删除前需要确认
- 删除后重新计算持仓和盈亏

#### 2.5 交易类型自动判断
系统会根据当前持仓自动判断交易的实际作用：

**买入（BUY）时：**
1. 如果存在空仓，优先平空仓
2. 如果空仓全部平完，剩余部分开多仓
3. 如果没有空仓，直接开多仓

**卖出（SELL）时：**
1. 如果存在多仓，优先平多仓
2. 如果多仓全部平完，剩余部分开空仓
3. 如果没有多仓，直接开空仓

---

### 3. 盈亏计算

#### 3.1 计算原则
系统使用**最大化收益算法**（最低成本法/最高价格法）来计算盈亏：

- **平多仓**：选择买入价最低的记录进行匹配，最大化收益
- **平空仓**：选择卖出价最高的记录进行匹配，最大化收益

#### 3.2 排序规则
交易记录按以下顺序排序：
1. **交易日期**：升序（最早在前）
2. **创建时间**：如果交易日期相同，按创建时间升序

#### 3.3 手续费扣除规则
**核心原则**：手续费和税费只有在交易记录被**完全平仓**时才一次性扣除。

**示例：**
- 买入100股，产生手续费A
- 卖出50股：不扣除手续费A（因为买入100股还没完全平仓）
- 再卖出50股：扣除全部手续费A（因为买入100股已完全平仓）

**具体规则：**
- **买入手续费**：只有在买入记录被完全平仓时才扣除
- **卖出手续费**：在卖出时立即扣除
- **开空仓手续费和税费**：只有在空仓被完全平仓时才扣除
- **平空仓手续费**：在买入平空仓时立即扣除

#### 3.4 盈亏计算公式

**平多仓盈亏：**
```
盈亏 = 卖出金额 - 买入成本 - 买入手续费（完全平仓时扣除） - 卖出手续费 - 卖出税费
```

**平空仓盈亏：**
```
盈亏 = 开空仓收入 - 平空仓成本 - 开空仓手续费（完全平仓时扣除） - 开空仓税费（完全平仓时扣除） - 买入手续费
```

**注意**：买入手续费在平空仓时不扣除，因为：
- 如果买入记录被完全平仓（全部用于平空仓），买入手续费会在该买入记录被卖出平仓时扣除
- 如果买入记录只部分平仓（部分用于平空仓，部分开多仓），买入手续费不应该扣除

---

### 4. 股票详情页

#### 4.1 页面结构
股票详情页包含以下几个部分：

1. **已平仓盈亏**
   - 显示该股票所有已平仓交易的累计盈亏
   - 盈利显示绿色，亏损显示红色
   - 根据股票类型显示对应货币符号

2. **当前持仓**
   - 表格展示当前所有持仓记录
   - 显示字段：
     - 交易日期
     - 类型（多仓/空仓）
     - 数量（股）
     - 成交价格
     - 总金额
   - 多仓和空仓分别显示，空仓数量显示为负数或标注为"空仓"

3. **开平仓明细**
   - 显示所有已平仓的交易对
   - 显示字段：
     - 类型（多仓/空仓）
     - 开仓日期
     - 平仓日期
     - 开仓价格
     - 平仓价格
     - 数量（股）
     - 盈亏
   - **排序规则**：按平仓日期倒序，如果日期相同则按平仓交易的创建时间倒序（最新的在前）

4. **成交记录明细**
   - 显示所有交易记录（买入和卖出）
   - 显示字段：
     - 日期
     - 类型（买入/卖出）
     - 数量（股）
     - 价格
     - 总金额
     - 手续费
     - 税费
     - 操作（删除按钮）
   - **排序规则**：按交易日期倒序，如果日期相同则按创建时间倒序（最新的在前）
   - **注意**：此表格不显示盈亏，盈亏只在"开平仓明细"中显示

---

### 5. 首页

#### 5.1 页面布局
首页包含以下内容（从上到下）：

1. **导航菜单**
   - "股票管理"按钮，跳转到股票管理页面

2. **股票列表**
   - 表格展示所有股票及其统计信息
   - 显示字段：
     - 股票名称
     - 股票类型（标签显示）
     - 买入金额（根据股票类型显示对应货币符号）
     - 卖出金额（根据股票类型显示对应货币符号）
     - 累计盈亏（根据股票类型显示对应货币符号，盈利绿色，亏损红色）
     - 操作（"查看详情"按钮）
   - 点击"查看详情"跳转到股票详情页

3. **添加交易记录表单**
   - 直接显示在页面下方
   - 支持添加和编辑交易记录
   - 编辑时表单自动填充数据

---

## 数据库设计

### stocks 表（股票表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 主键，自增 |
| name | VARCHAR(100) | NOT NULL, UNIQUE | 股票名称，唯一 |
| stock_type | TINYINT | NOT NULL, DEFAULT 1 | 股票类型：1=A股, 2=港股, 3=美股 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- `idx_name`：股票名称索引
- `idx_stock_type`：股票类型索引

### transactions 表（交易记录表）

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | INT | PRIMARY KEY, AUTO_INCREMENT | 主键，自增 |
| stock_name | VARCHAR(100) | NOT NULL | 股票名称 |
| transaction_type | ENUM('BUY', 'SELL') | NOT NULL | 交易类型：买入/卖出 |
| quantity | INT | NOT NULL | 交易数量（股） |
| price | DECIMAL(10, 2) | NOT NULL | 交易价格 |
| transaction_date | DATE | NOT NULL | 交易日期 |
| total_amount | DECIMAL(12, 2) | NOT NULL | 交易总金额 |
| commission | DECIMAL(12, 2) | DEFAULT 0 | 手续费 |
| tax | DECIMAL(12, 2) | DEFAULT 0 | 税费 |
| profit_loss | DECIMAL(12, 2) | DEFAULT 0 | 盈亏金额 |
| notes | TEXT | NULL | 备注 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |

**索引：**
- `idx_stock_name`：股票名称索引
- `idx_transaction_date`：交易日期索引

**外键：**
- `stock_name` 引用 `stocks(name)` ON DELETE RESTRICT

---

## API接口

### 股票管理接口

#### 1. 获取所有股票
- **URL**: `GET /api/stocks`
- **响应**:
```json
{
  "status": "OK",
  "data": [
    {
      "id": 1,
      "name": "平安银行",
      "stock_type": "A股",
      "created_at": "2024-01-01T00:00:00.000Z",
      "updated_at": "2024-01-01T00:00:00.000Z"
    }
  ]
}
```

#### 2. 获取单只股票
- **URL**: `GET /api/stocks/:id`
- **参数**: `id` - 股票ID

#### 3. 获取股票详情（包含持仓和盈亏）
- **URL**: `GET /api/stocks/:name/detail`
- **参数**: `name` - 股票名称（URL编码）
- **响应**:
```json
{
  "status": "OK",
  "data": {
    "stockName": "平安银行",
    "currentPosition": 100,
    "positions": [
      {
        "id": 1,
        "date": "2024-01-01",
        "quantity": 100,
        "price": 10.50,
        "totalAmount": 1050.00,
        "type": "LONG"
      }
    ],
    "closedProfitLoss": 50.00,
    "closedPositions": [
      {
        "openDate": "2024-01-01",
        "closeDate": "2024-01-10",
        "openPrice": 10.00,
        "closePrice": 10.50,
        "quantity": 100,
        "profitLoss": 50.00,
        "type": "LONG"
      }
    ],
    "transactions": [...]
  }
}
```

#### 4. 创建股票
- **URL**: `POST /api/stocks`
- **请求体**:
```json
{
  "name": "平安银行",
  "stock_type": "A股"
}
```

#### 5. 更新股票
- **URL**: `PUT /api/stocks/:id`
- **请求体**: 同创建股票

#### 6. 删除股票
- **URL**: `DELETE /api/stocks/:id`

### 交易记录接口

#### 1. 获取所有交易记录
- **URL**: `GET /api/transactions`
- **排序**: 按交易日期倒序，创建时间倒序

#### 2. 获取单笔交易记录
- **URL**: `GET /api/transactions/:id`

#### 3. 根据股票名称获取交易记录
- **URL**: `GET /api/transactions/stock/:stockName`
- **排序**: 按交易日期升序，创建时间升序

#### 4. 创建交易记录
- **URL**: `POST /api/transactions`
- **请求体**:
```json
{
  "stock_name": "平安银行",
  "transaction_type": "BUY",
  "quantity": 100,
  "price": 10.50,
  "transaction_date": "2024-01-01",
  "notes": "备注信息",
  "commission": 0.16  // 仅美股需要
}
```

#### 5. 更新交易记录
- **URL**: `PUT /api/transactions/:id`
- **请求体**: 同创建交易记录

#### 6. 删除交易记录
- **URL**: `DELETE /api/transactions/:id`

#### 7. 获取盈亏统计
- **URL**: `GET /api/transactions/stats/profit-loss`
- **响应**:
```json
{
  "status": "OK",
  "data": {
    "overall": {
      "total_transactions": 10,
      "total_buy_amount": 10000.00,
      "total_sell_amount": 10500.00,
      "total_profit_loss": 500.00
    },
    "byStock": [
      {
        "stock_name": "平安银行",
        "total_buy_amount": 5000.00,
        "total_sell_amount": 5200.00,
        "total_profit_loss": 200.00
      }
    ]
  }
}
```

---

## 前端页面

### 1. 首页（App.js）

**路径**: `/`

**功能**:
- 显示股票列表（带统计信息）
- 显示添加/编辑交易记录表单
- 导航到股票管理页面

**组件**:
- `TransactionForm`: 交易记录表单
- 股票列表表格（内联）

### 2. 股票管理页面（StockManagement.js）

**路径**: 通过首页导航进入

**功能**:
- 显示所有股票列表
- 添加新股票
- 编辑股票信息
- 删除股票

**操作流程**:
1. 点击"添加股票"按钮显示表单
2. 填写股票名称和选择股票类型
3. 点击"保存"创建股票
4. 点击"编辑"按钮修改股票信息
5. 点击"删除"按钮删除股票（需确认）

### 3. 股票详情页（StockDetail.js）

**路径**: 通过首页股票列表的"查看详情"按钮进入

**功能**:
- 显示已平仓盈亏
- 显示当前持仓
- 显示开平仓明细
- 显示成交记录明细
- 删除成交记录

**数据加载**:
- 页面加载时自动获取股票详情
- 删除交易记录后自动刷新

### 4. 交易记录表单（TransactionForm.js）

**功能**:
- 选择股票（下拉选择）
- 选择交易类型（单选按钮：买入/卖出）
- 输入数量、价格
- 选择交易日期（日期选择器）
- 输入备注
- 美股时输入手续费
- 自动计算和显示手续费、税费
- 显示交易总金额

**表单验证**:
- 所有必填字段验证
- 数量必须为正整数
- 价格必须为正数
- 美股手续费必填

---

## 业务逻辑

### 1. 持仓计算逻辑

系统维护两个持仓数组：
- `buyPositions`: 多仓持仓记录
- `sellPositions`: 空仓持仓记录

**处理买入（BUY）时：**
1. 遍历所有空仓持仓，优先平空仓
2. 如果还有剩余数量，添加到多仓持仓

**处理卖出（SELL）时：**
1. 遍历所有多仓持仓，优先平多仓
2. 如果还有剩余数量，添加到空仓持仓

### 2. 盈亏计算逻辑

#### 2.1 平多仓盈亏计算

**步骤：**
1. 获取所有交易记录，按 `transaction_date ASC, created_at ASC` 排序
2. 构建多仓持仓数组（买入记录）
3. 当遇到卖出记录时：
   - 从多仓持仓中选择价格最低的记录（最大化收益）
   - 计算平仓数量
   - 计算盈亏 = 卖出金额 - 买入成本 - 手续费 - 税费
   - 如果买入记录完全平仓，扣除买入手续费
   - 扣除卖出手续费和税费

#### 2.2 平空仓盈亏计算

**步骤：**
1. 获取所有交易记录，按 `transaction_date ASC, created_at ASC` 排序
2. 构建空仓持仓数组（卖出记录）
3. 当遇到买入记录时：
   - 从空仓持仓中选择价格最高的记录（最大化收益）
   - 计算平仓数量
   - 计算盈亏 = 开空仓收入 - 平空仓成本 - 手续费 - 税费
   - 如果空仓记录完全平仓，扣除开空仓手续费和税费
   - 注意：买入手续费不在平空仓时扣除

### 3. 手续费和税费计算

#### 3.1 自动计算规则

**A股：**
- 手续费：买入/卖出 = 总金额 × 0.00012（万1.2）
- 税费：仅卖出 = 总金额 × 0.0005（万分之5 = 5/10000）

**港股：**
- 手续费：买入/卖出 = 总金额 × 0.0002（万2）
- 税费：买入/卖出 = 总金额 × 0.001（千分之1）

**美股：**
- 手续费：手动输入
- 税费：0

#### 3.2 扣除时机

- **买入手续费**：只有在买入记录被完全平仓时才扣除
- **卖出手续费**：在卖出时立即扣除
- **卖出税费**：在卖出时立即扣除
- **开空仓手续费和税费**：只有在空仓被完全平仓时才扣除

### 4. 货币单位显示

系统根据股票类型自动显示对应的货币符号：

- **A股**：¥（人民币）
- **港股**：HK$（港元）
- **美股**：$（美元）

**实现方式：**
- 工具函数 `getCurrencySymbol(stockType)` 根据股票类型返回货币符号
- 所有金额显示处都使用此函数

---

## 技术实现

### 1. 后端技术栈

- **Node.js** + **Express**
- **MySQL** 数据库
- **mysql2/promise** 数据库驱动

### 2. 前端技术栈

- **React** 框架
- **axios** HTTP客户端
- **react-datepicker** 日期选择器
- **date-fns** 日期格式化

### 3. 项目结构

```
stock/
├── server/                 # 后端代码
│   ├── config/
│   │   └── database.js     # 数据库配置
│   ├── routes/
│   │   ├── stocks.js       # 股票路由
│   │   └── transactions.js # 交易记录路由
│   ├── services/
│   │   ├── stockService.js      # 股票业务逻辑
│   │   └── transactionService.js # 交易记录业务逻辑
│   └── index.js           # 服务器入口
├── client/                 # 前端代码
│   └── src/
│       ├── components/     # React组件
│       │   ├── StockDetail.js
│       │   ├── StockManagement.js
│       │   ├── TransactionForm.js
│       │   └── ...
│       ├── services/
│       │   └── api.js      # API调用封装
│       ├── utils/
│       │   └── currency.js # 货币工具函数
│       └── App.js          # 主应用组件
├── database/               # 数据库脚本
│   ├── schema.sql          # 数据库结构
│   └── migration.sql       # 迁移脚本
└── package.json
```

### 4. 关键算法

#### 4.1 最大化收益匹配算法

**平多仓时选择最低买入价：**
```javascript
// 从多仓持仓中选择价格最低的记录
let minPriceIndex = -1;
let minPrice = Infinity;
for (let i = 0; i < buyPositions.length; i++) {
  if (buyPositions[i].quantity > 0 && buyPositions[i].price < minPrice) {
    minPrice = buyPositions[i].price;
    minPriceIndex = i;
  }
}
```

**平空仓时选择最高卖出价：**
```javascript
// 从空仓持仓中选择价格最高的记录
let maxPriceIndex = -1;
let maxPrice = -1;
for (let i = 0; i < sellPositions.length; i++) {
  if (sellPositions[i].quantity > 0 && sellPositions[i].price > maxPrice) {
    maxPrice = sellPositions[i].price;
    maxPriceIndex = i;
  }
}
```

#### 4.2 手续费扣除判断

```javascript
// 判断是否完全平仓
if (usedQty === longPos.quantity) {
  // 完全平仓，扣除全部买入手续费
  buyCommission = longPos.commission || 0;
} else {
  // 部分平仓，不扣除手续费
  buyCommission = 0;
}
```

### 5. 数据流转

1. **添加交易记录**：
   - 前端表单提交 → API创建交易记录
   - 后端计算手续费和税费
   - 后端计算盈亏（调用盈亏计算服务）
   - 返回创建的交易记录

2. **查看股票详情**：
   - 前端请求股票详情API
   - 后端获取所有交易记录
   - 后端计算当前持仓
   - 后端计算已平仓盈亏和开平仓明细
   - 返回完整详情数据

3. **删除交易记录**：
   - 前端确认删除
   - API删除记录
   - 前端刷新股票详情（重新计算）

### 6. 错误处理

- **数据库错误**：返回500状态码和错误信息
- **验证错误**：返回400状态码和具体错误信息
- **未找到资源**：返回404状态码
- **前端错误**：显示错误提示，不阻塞用户操作

---

## 总结

本系统实现了完整的股票交易记录管理功能，包括：

1. ✅ 股票管理（增删改查）
2. ✅ 交易记录管理（增删改查）
3. ✅ 自动持仓计算（支持多仓和空仓）
4. ✅ 自动盈亏计算（最大化收益算法）
5. ✅ 手续费和税费自动计算（根据股票类型）
6. ✅ 股票详情展示（持仓、盈亏、明细）
7. ✅ 多货币单位支持（人民币、港元、美元）
8. ✅ 响应式UI设计

系统采用前后端分离架构，使用React构建前端界面，Node.js + Express构建后端API，MySQL存储数据。所有业务逻辑都在后端实现，确保数据一致性和安全性。

